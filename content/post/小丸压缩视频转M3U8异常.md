+++
date = "2018-03-03T18:07:46+08:00"
title = "小丸压缩视频转M3U8异常"
draft = false
tags = ["整理","异常处理","FFMPEG"]
share = true
+++


[TOC]

# 异常反馈
- `2 frames left in the queue on closing`
```
[2018/01/08:11:37:43] [ERROR] FFMPEG.STDERR:ffmpeg version 3.3.2 Copyright (c) 2000-2017 the FFmpeg developers
  built with gcc 4.8.2 (GCC) 20140120 (Red Hat 4.8.2-16)
  configuration: --extra-cflags=-I/usr/local/ffmpeg/include --extra-ldflags=-L/usr/local/ffmpeg/lib --pkg-config-flags=--static --enable-libmp3lame --enable-gpl --enable-libvorbis --enable-libvpx --enable-libx264 --prefix=/usr/local/ffmpeg --extra-libs=-ldl
  libavutil      55. 58.100 / 55. 58.100
  libavcodec     57. 89.100 / 57. 89.100
  libavformat    57. 71.100 / 57. 71.100
  libavdevice    57.  6.100 / 57.  6.100
  libavfilter     6. 82.100 /  6. 82.100
  libswscale      4.  6.100 /  4.  6.100
  libswresample   2.  7.100 /  2.  7.100
  libpostproc    54.  5.100 / 54.  5.100
Input #0, mov,mp4,m4a,3gp,3g2,mj2, from '/static/cdn/prod/video/27c82cb0-2e6f-471e-b038-20488b0ae82c.mp4':
  Metadata:
    major_brand     : isom
    minor_version   : 512
...skipping...
  configuration: --extra-cflags=-I/usr/local/ffmpeg/include --extra-ldflags=-L/usr/local/ffmpeg/lib --pkg-config-flags=--static --enable-libmp3lame --enable-gpl --enable-libvorbis --enable-libvpx --enable-libx264 --prefix=/usr/local/ffmpeg --extra-libs=-ldl
  libavutil      55. 58.100 / 55. 58.100
  libavcodec     57. 89.100 / 57. 89.100
  libavformat    57. 71.100 / 57. 71.100
  libavdevice    57.  6.100 / 57.  6.100
  libavfilter     6. 82.100 /  6. 82.100
  libswscale      4.  6.100 /  4.  6.100
  libswresample   2.  7.100 /  2.  7.100
  libpostproc    54.  5.100 / 54.  5.100
[mov,mp4,m4a,3gp,3g2,mj2 @ 0x30f35e0] stream 0, timescale not set
Input #0, mov,mp4,m4a,3gp,3g2,mj2, from '/static/cdn/prod/video/38ad11be-f1c7-4dea-9ce0-6ed13a93d906.mp4':
  Metadata:
    major_brand     : isom
    minor_version   : 1
    compatible_brands: isom
    creation_time   : 2017-06-26T08:38:48.000000Z
  Duration: 00:06:01.69, start: 0.000000, bitrate: 485 kb/s
    Stream #0:0(und): Video: h264 (High) (avc1 / 0x31637661), yuv420p(tv, bt709/unknown/unknown), 1920x1080, 340 kb/s, 25 fps, 25 tbr, 25 tbn, 50 tbc (default)
    Metadata:
      creation_time   : 2017-06-26T08:31:14.000000Z
      handler_name    : GPAC ISO Video Handler
    Stream #0:1(und): Audio: aac (LC) (mp4a / 0x6134706D), 48000 Hz, stereo, fltp, 129 kb/s (default)
    Metadata:
      creation_time   : 2017-06-26T08:38:48.000000Z
      handler_name    : GPAC ISO Audio Handler
    Stream #0:2: Video: png, rgba(pc), 1920x1080, 90k tbr, 90k tbn, 90k tbc
Stream mapping:
  Stream #0:0 -> #0:0 (h264 (native) -> h264 (libx264))
  Stream #0:1 -> #0:1 (aac (native) -> aac (native))
  Stream #0:2 -> #0:2 (png (native) -> h264 (libx264))
Press [q] to stop, [?] for help
[libx264 @ 0x312d8e0] using cpu capabilities: MMX2 SSE2Fast SSSE3 SSE4.2 AVX
[libx264 @ 0x312d8e0] profile High, level 3.0
Past duration 0.639992 too large
Past duration 0.679985 too large
Past duration 0.719994 too large
Past duration 0.759987 too large
Past duration 0.799995 too large
Past duration 0.839989 too large
Past duration 0.879997 too large
Past duration 0.919991 too large
Past duration 0.959999 too large
frame=   66 fps=0.0 q=0.0 q=0.0 size=N/A time=-577014:32:22.77 bitrate=N/A dup=0 drop=1 speed=N/A    ^Mframe=  120 fps=120 q=0.0 q=0.0 size=N/A time=-577014:32:22.77 bitrate=N/A dup=0 drop=3 speed=N/A    ^MToo many packets buffered for output stream 0:1.
[libx264 @ 0x312d8e0] frame I:3     Avg QP:22.11  size:  3669
[libx264 @ 0x312d8e0] frame P:43    Avg QP:23.84  size:  2862
[libx264 @ 0x312d8e0] frame B:51    Avg QP:24.78  size:   931
[libx264 @ 0x312d8e0] consecutive B-frames: 24.5% 10.2% 12.2% 53.1%
[libx264 @ 0x312d8e0] mb I  I16..4: 11.7% 80.6%  7.7%
[libx264 @ 0x312d8e0] mb P  I16..4:  6.8%  9.1%  4.9%  P16..4: 11.0%  4.2%  1.8%  0.0%  0.0%    skip:62.1%
[libx264 @ 0x312d8e0] mb B  I16..4:  0.7%  0.9%  0.4%  B16..8: 21.6%  4.2%  0.8%  direct: 0.6%  skip:70.9%  L0:42.2% L1:50.3% BI: 7.5%
[libx264 @ 0x312d8e0] 8x8 transform intra:52.4% inter:59.5%
[libx264 @ 0x312d8e0] coded y,uvDC,uvAC intra: 26.9% 37.5% 21.8% inter: 3.8% 3.9% 1.2%
[libx264 @ 0x312d8e0] i16 v,h,dc,p: 37% 52%  5%  6%
[libx264 @ 0x312d8e0] i8 v,h,dc,ddl,ddr,vr,hd,vl,hu: 47% 24% 16%  2%  2%  3%  3%  2%  2%
[libx264 @ 0x312d8e0] i4 v,h,dc,ddl,ddr,vr,hd,vl,hu: 35% 32% 12%  4%  4%  4%  4%  3%  2%
[libx264 @ 0x312d8e0] i8c dc,h,v,p: 46% 32% 17%  5%
[libx264 @ 0x312d8e0] Weighted P-Frames: Y:0.0% UV:0.0%
[libx264 @ 0x312d8e0] ref P L0: 69.0%  6.9% 13.9% 10.2%
[libx264 @ 0x312d8e0] ref B L0: 83.8% 11.4%  4.8%
[libx264 @ 0x312d8e0] ref B L1: 94.0%  6.0%
[libx264 @ 0x312d8e0] kb/s:359.41
[aac @ 0x312e3c0] Qavg: 1583.189
[aac @ 0x312e3c0] 2 frames left in the queue on closing
Conversion failed!

[2018/03/01:10:28:38] [ERROR] KafkaMsgHandler.convert fail: exit status 1
[2018/03/01:10:28:39] [ERROR] ReTry[10]: retry count is out of limit
```


# Command
- 原始转换请求转换语句
```
/usr/local/ffmpeg/bin/ffmpeg -i /static/cdn/prod/video/38ad11be-f1c7-4dea-9ce0-6ed13a93d906.mp4 -vcodec libx264 -r 24 -vf scale=640:360,pad=640:360:0:0:black -acodec aac -ar 22050 -ab 24k -map 0  -f ssegment -segment_format mpegts -segment_list /static/cdn/prod/video/38ad11be-f1c7-4dea-9ce0-6ed13a93d906_640x360/index.m3u8 -segment_time 10 /static/cdn/prod/video/38ad11be-f1c7-4dea-9ce0-6ed13a93d906_640x360/%04d.ts
```


# Info
- `/usr/local/ffmpeg/bin/ffprobe -i /static/cdn/prod/video/38ad11be-f1c7-4dea-9ce0-6ed13a93d906.mp4`
- 客户使用**「小丸」**进行视频压缩，添加末帧**图片作为视频流**，导致转 M3U8 时缓存不足引起转换失败
  - 理解为 FFMPEG 进行转码时，对各通道流进行同步缓存
  - 而图片流中图片仅存在于末帧，导致需要缓存的数据过多引发如上异常
  - 仅为与同事探讨的可能，如有知情，请烦请知会
  ```
  ffprobe version 3.3.2 Copyright (c) 2007-2017 the FFmpeg developers
    built with gcc 4.8.2 (GCC) 20140120 (Red Hat 4.8.2-16)
    configuration: --extra-cflags=-I/usr/local/ffmpeg/include --extra-ldflags=-L/usr/local/ffmpeg/lib --pkg-config-flags=--static --enable-libmp3lame --enable-gpl --enable-libvorbis --enable-libvpx --enable-libx264 --prefix=/usr/local/ffmpeg --extra-libs=-ldl
    libavutil      55. 58.100 / 55. 58.100
    libavcodec     57. 89.100 / 57. 89.100
    libavformat    57. 71.100 / 57. 71.100
    libavdevice    57.  6.100 / 57.  6.100
    libavfilter     6. 82.100 /  6. 82.100
    libswscale      4.  6.100 /  4.  6.100
    libswresample   2.  7.100 /  2.  7.100
    libpostproc    54.  5.100 / 54.  5.100
  [mov,mp4,m4a,3gp,3g2,mj2 @ 0x3b14b00] stream 0, timescale not set
  Input #0, mov,mp4,m4a,3gp,3g2,mj2, from '/static/cdn/prod/video/38ad11be-f1c7-4dea-9ce0-6ed13a93d906.mp4':
    Metadata:
      major_brand     : isom
      minor_version   : 1
      compatible_brands: isom
      creation_time   : 2017-06-26T08:38:48.000000Z
    Duration: 00:06:01.69, start: 0.000000, bitrate: 485 kb/s
      Stream #0:0(und): Video: h264 (High) (avc1 / 0x31637661), yuv420p(tv, bt709/unknown/unknown), 1920x1080, 340 kb/s, 25 fps, 25 tbr, 25 tbn, 50 tbc (default)
      Metadata:
        creation_time   : 2017-06-26T08:31:14.000000Z
        handler_name    : GPAC ISO Video Handler
      Stream #0:1(und): Audio: aac (LC) (mp4a / 0x6134706D), 48000 Hz, stereo, fltp, 129 kb/s (default)
      Metadata:
        creation_time   : 2017-06-26T08:38:48.000000Z
        handler_name    : GPAC ISO Audio Handler
      Stream #0:2: Video: png, rgba(pc), 1920x1080, 90k tbr, 90k tbn, 90k tbc
  ```    



# Ask
- [ffmpeg -max_muxing_queue_size](https://ffmpeg.org/ffmpeg.html)
- [[bug][regression] Too many packets buffered for output stream](https://trac.ffmpeg.org/ticket/6375#no2)
- [Conversion failed! by Too many packets buffered for output stream 0:0. in wmv](https://trac.ffmpeg.org/ticket/6472)


# Try
- `-max_muxing_queue_size 9999`
  - `06:01.69 485 kb/s 1920x1080`情况下视频，`9999`值足够使用
  - 时间超过**6min**则出现不足异常


# TODO
## Query
- 具体业务相关，略


## Demo
- 具体业务相关，略


## Command
```
/usr/local/ffmpeg/bin/ffmpeg -i /static/cdn/prod/video/57027182-0cba-4746-8eb4-8d4501da66d1.mp4 -vcodec libx264 -r 24 -vf scale=640:360,pad=640:360:0:0:black -acodec aac -ar 22050 -ab 24k -map 0 -f ssegment -segment_format mpegts -segment_list /static/cdn/prod/video/57027182-0cba-4746-8eb4-8d4501da66d1_640x360/index.m3u8 -segment_time 10 /static/cdn/prod/video/57027182-0cba-4746-8eb4-8d4501da66d1_640x360/%04d.ts

Kafka.Producer send(av, 1, {"env":"prod","args":"id_37976-type_exercise","req":{"type":3,"from":"/static/cdn/prod/video/57027182-0cba-4746-8eb4-8d4501da66d1.mp4","to":"/static/cdn/prod/video/57027182-0cba-4746-8eb4-8d4501da66d1_640x360","args":"format=phone"}})
```

# Update
- 具体业务相关，略

# Request
- 具体业务相关，略