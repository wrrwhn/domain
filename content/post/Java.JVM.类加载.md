---
title: "Java.JVM.类加载"
date: "2019-01-04"
categories:
 - "整理"
tags:
 - "Java"
 - "JVM"
toc: true
---

# 概念

- 将 .class 文件读取到内存，并生成对象的过程
	- 读取 .class 文件的二进制流数据
	- 在方法区中生成类的结构
	- 在堆区生成该类的 `java.lang.Class` 对象
		- 提供访问方法区中类结构的**接口**

- 可在某类被使用前，预先加载
	- 加载类时文件缺失或异常
		- 首次加载时报 `LinkageError` 错误
		- 若一直未使用，则不报错

# 流程

## 过程

| 阶段 |  阶段  | 阶段 |
|------|--------|------|
| 加载 |        |      |
|      | 加载   |      |
|      | 连接   |      |
|      |        | 验证 |
|      |        | 准备 |
|      |        | 解析 |
|      | 初始化 |      |
| 使用 |        |      |
| 卸载 |        |      |


## 细节

### 加载
- 描述
	- 由加载、验证、准备、解析和初始化组成
	- 除解析各阶段顺序开始
		- 解析可发生于初始化阶段之后
		- 运行时绑定

- 步骤
	- 加载、连接该类
	- 若父类未初始化，则先初始化父类
	- 依次执行初始化语句（静态代码块）	

- 时机
	- 立即
		- 类实例创建
		- 类或接口的静态变量的请求、赋值
		- 类的静态方法调用
		- 反射
			- `Class.forName("全限定名“)`
		- 初始化类的父类
		- `java` 启动时指定的主类
	- 其它均为懒加载情况
		- 需要时再加载进来

- 注意
	- `<clinit>` 是线程安全的懒汉单例模式


### 加载.加载
- 查找& 加载类的二进制数据
	- 通过**全限定名**获取二进制流
	- 在方法区，转化静态结构为运行时数据结构
	- 于堆区，生成该类的 `java.lang.Class` 对象
		- 指向方法区的结构

### 加载.连接.验证
- 确保被加载类的正确性
	- 验证文件格式
		- 是否符合 Class **文件格式规范**
			- 开头是否为 `0xCAFEBABE`
			- 版本号是否在当前 VM 支持范围内
			- 常量池中类型是否支持
	- 验证元数据
		- 语义分析，是否符合 Java **语言规范**
			- 是否具有父类
	- 验证字节码
		- 数据流&控制流分析，判断**语义是否合法**
	- 验证**符号引用**
		- 为之后解析作准备

- 重要非必须
	- 可通过 `-Xverifynone` 参数关闭

### 加载.连接.准备
- 为类的静态变量分配内存，并初始为默认值
	
	| 修饰符       | 动作                                                                              |
	|--------------|---------------------------------------------------------------------------------|
	| static       | 分配内存<br>设置值为该类型的默认值，如0/ null/ false<br>实际值于**初始化阶段填充** |
	| final static | 分配内存<br>填充指定值，且值存储于**常量池**中                                     |

### 加载.连接.解析
- 将类中的**符号引用转换为直接引用**
	- 针对类、接口、字段、类方法、接口方法、接口类型、方法类型、方法句柄和调用点限定符
	- 都是解析过程时无法直接给定直接引用，后续于父类、接口加载完成后，再行替换的操作


### 加载.初始化
- 作用
	- 使用**静态代码块**为静态变量赋值
	- 声明**类变量**为指定初始值

### 使用

### 卸载

## 图示

- ![JVM-Class-Load.png](http://doc.yqjdcyy.com/8e0a8f55-21c7-41a5-bbe5-ed2598f5738a.png)


# 类加载器

## 描述
- 加载阶段，用于将字节码装载至 JVM
- 可定制化实现，但会跳出现有的装载流程

## 分类

|                  名称                 |               实现               |                     针对项                      |
|---------------------------------------|----------------------------------|-------------------------------------------------|
| 启动项加载器<br>Bootstrap ClassLoader | Hotspot: C++                     | JDK\jre\lib<br>-Xbootclasspath                  |
| 扩展类加载器<br>ExtClassLoader        | sun.misc.Launcher$ExtClassLoader | JDK\jre\lib\ext<br>系统变量java.ext.dirs        |
| 应用类加载器<br>AppClassLoader        | sun.misc.Launcher$AppClassLoader | ClassPath 用户类路径                            |
| 自定义类加载器                        | implement ClassLoader            | 自动验证数字签名<br>从网络等渠道获取 class 文件 |


## 机制

|   机制   |                            描述                            |
|----------|------------------------------------------------------------|
| 全盘负责 | 一个类加载器加载某类时，该类所依赖和引用的类均将由其加载   |
| 父类委托 | 尝试先由父类加载器尝试加载，加载失败后才从自身类路径中加载 |
| 缓存机制 | 缓存所有加载过的类                                         |


## 方式

|          方式         |                    描述                    |
|-----------------------|--------------------------------------------|
| 命令行标注            | `javac -Djava.ext.dirs=`                   |
| Class.forName         | 会执行类中的 static 块                     |
| ClassLoader.loadClass | 仅加载类文件<br>类实例化时才执行 static 块 |


## 模型
- 双亲委派模型
	- 优点
		- 避免出现多份同样的字节码
		- 保证 Java 的安全稳定
	- 图示
		- ![JVM-ClassLoader.png](http://doc.yqjdcyy.com/db25d228-13f2-428e-85dd-40eaecb6a698.png)



# 补充
## 引用

- 符号引用
	- 描述目标的符号、字面量
	- 如类A中引用了类B，在编译过程中会于类A中使用 `CONSTANT_Class_info` 符号表示类 B 的地址

- 直接引用

	|      类型      |                     示例                    |
	|----------------|---------------------------------------------|
	| 目标指针       | 类的 Class 对象指针、类变量指针、类方法指针 |
	| 相对偏移量     | 相对实例变量、实例方法的直接引用            |
	| 间接定位的句柄 |                                             |

## 常量池
- 位置
	- Heap
		- 运行时常量池
		- 字符串常量池均存储于
			- jdk 1.7+ 版本

- 存储内容
	- 字面量
		- Literal
		- 双引号包起来的文本字符串
	- 符号引用
		- Symbolic References
		- 类和接口的全限定名
		- 字段名称和描述符
		- 方法的名称和描述符

- 备注
	- HotSpot VM 中的常量池本质是 `HashSet<String>`
		- 只存储 java.lang.String 实例的**引用**


# 参考
- [java类的加载机制](http://www.cnblogs.com/ityouknow/p/5603287.html)	
- [JVM 类加载机制深入浅出](https://www.jianshu.com/p/3cab74a189de)	
	- 事例众多，如破坏双亲委派模型的事例
- [JVM中的直接引用和符号引用](https://blog.csdn.net/u014656992/article/details/51107127)
	- 符号引用和直接引用
- [JVM里的符号引用如何存储？](https://www.zhihu.com/question/30300585)
	- 符号引用示例
- [Chapter 5. Loading, Linking, and Initializing](https://docs.oracle.com/javase/specs/jvms/se7/html/jvms-5.html#jvms-5.1)	
	- 官方文档
- [学习JVM是如何从入门到放弃的？](https://segmentfault.com/a/1190000015605327)	
	- 针对intern() 和常量池有效的图形展示