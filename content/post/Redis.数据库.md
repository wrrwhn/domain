---
title: "Redis.数据库"
date: "2018-11-25"
categories:
 - "整理"
tags:
 - "Redis"
toc: true
---


# 结构

- 属性

    | 变量           | 作用                      |
    |----------------|-------------------------|
    | id             | 数据库编码                |
    | *dict          | 键值对数据                |
    | *expires       | 键值过期情况              |
    | *blocking_keys | 阻塞命令所需              |
    | *ready_keys    | 阻塞命令所需              |
    | *watched_keys  | 配合 `WATCH` 命令实现事务 |

- 图示
    - ![REDIS-DB.png](http://doc.yqjdcyy.com/3cebd835-afc8-48d3-81b5-3e650bc52a31.png)


# 数据库号码
- redisDB.id 值即为当前数据库在 redisServer.DB 列表中的下标值
    - 如 `SELECT 0` 时即选中 `redisServer.DB[0]`
    - 而在内部使用中，将通过遍历 `redisServer.DB` 队列，判断与持有的当前使用数据库的指针一致，以获取所使用的数据库 ID

# 键空间

- 字典结构
- 除实现键值的增删改查，还维护**命中率**、**LRU**-最近最少使用、过期、事务和数据同步

# 键值过期
- 结构
    - 字典数据结构
    - 其中键值为 `dict.key` 的位置指针，而值为实际的到期时间
        - 单位为 **以毫秒为单位的 UNIX 时间戳**

- 过期判定
    - ![REDIS-EXPIRES-CHECK.png](http://doc.yqjdcyy.com/fbe02617-8128-4e4e-8770-d411a61e47e2.png)

- 命令

    | 类型 | 命令      | 描述                                                        |
    |------|-----------|-------------------------------------------------------------|
    | 设置 |           |                                                             |
    |      | EXPIRE    | 设置剩余有效时间，单位为`秒`                                 |
    |      | PEXPIRE   | 作用同上，但单位为 `毫秒`                                    |
    |      | EXPIREAT  | 设置键将于指定时间后过期，参数为以`秒`为单位的 `UNIX 时间戳` |
    |      | PEXPIREAT | 作用同上，参数为以`毫秒`为单位的 `UNIX 时间戳`               |
    | 查询 |           |                                                             |
    |      | TTL       | 查询键舉的剩余有效时间，单位为`秒`                           |
    |      | PTTL      | 作用同上，单位为`毫秒`                                       |

- 策略
    - Redis 使用的策略为 `惰性删除`+ `定期删除`

    | 策略     | 描述                                                   | 优势     | 缺陷                                            |
    |--------|------------------------------------------------------|--------|-----------------------------------------------|
    | 定时删除 | 设置过期时间时，同步创建定时事件，以按时自动执行键的删除 | 内存友好 | 占用CPU<br>遍历事件的无序链表，时间复杂度为 O(N) |
    | 惰性删除 | 当获取键值时，判断键值是否过期，如果过期就删除           | CPU友好  | 内存最不友好<br>若未被访问则无法删除            |
    | 定期删除 | 每隔一段时间进行检查，移除所有过期的键值                | 折中     | 折中                                            |

- 影响  

    | 功能     | 是否影响 | 原因                                                                                                                         |
    |----------|----------|----------------------------------------------------------------------------------------------------------------------------|
    | RDB      | No       | 创建RDB文件时，会对键的过期时间进行过滤筛选                                                                                   |
    | AOF      | NO       | 过期删除后，程序会追加删除命令                                                                                                |
    | AOF 重写 | NO       | 重写时，会过滤过期的键                                                                                                        |
    | 复制     | NO       | 主节点于删除后，同步发送删除命令<br>附属节点判断键值过期返回信息，并向主节点申报键过期；待主节点确认后同步发送了删除命令，再删除 |

# 收缩&扩容
- 参见 [字典.扩容](Redis.数据结构.字典.md#扩容)


# 参考
- [antirez/redis](https://github.com/antirez/redis)
- [数据库](https://redisbook.readthedocs.io/en/latest/internal/db.html)
- [redis的事务和watch](https://www.jianshu.com/p/361cb9cd13d5)
- [数据库键空间](http://redisbook.com/preview/database/key_space.html)
- [PEXPIRE](http://redisdoc.com/key/pexpire.html)