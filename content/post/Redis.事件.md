---
title: "Redis.事件"
date: "2018-11-25"
categories:
 - "整理"
tags:
 - "Redis"
toc: true
---

# 概览
- 类型
    - 文件事件
    - 时间事件

- 优先级
    - **文件事件> 时间事件**

- 调用
    - 文件事件和时间事件依次进行
    - 文件事件优先（命令读取、返回）于时间事件
        - 导致后者执行时间，**较预定时间晚一些**  
        - 文件事件和时间事件**不**进行**抢占**操作

# 详解
## 文件事件
### 定义
- 对套接字的**多路复用**而产生的事件

### 对照

| 事件类型 | 作用               | 生命周期                        | 状态                                                          |
|-------|------------------|-----------------------------|-------------------------------------------------------------|
| 读事件   | 客户端进行命令请求 | 连接时绑定，断开时才移除         | 等待：等待客户端发起请求<br>就绪：请求已发送，并已到达           |
| 写事件   | 服务端返回命令结果 | 服务器完成时发起，传送完毕后移除 | 等待：等候服务器处理命令<br>已就绪：返回命令结果，等待客户端接收 |  

### 注意
- 读事件周期优先于写事件周期
    - 存在读事件和写事件同时就绪的情况，此时**优先处理读事件**
- 时间事件执行时，将遍历所有链表，检查 `when` 是否触发

## 时间事件
### 描述
- 在指定时间点运行的事件，以无序链表的形式保存于服务器
- 属性

    | 属性     | 含义                                                                              |
    |----------|---------------------------------------------------------------------------------|
    | when     | 事件执行时间点<br>UNIX 时间戳的毫秒格式                                           |
    | timeProc | 事件处理函数<br>可分为单次和循环执行类型，后者将于完成时更新 when 属性值以继续运行 |
    | next     | 指向下一事件                                                                      |

### 调用
- 由 `redis.c/serverCron` 实现

### 实现场景
- 更新`统计`信息，如时间、内存占用等
- 清理`过期`键值对
- 关闭和清理已`失效`的客户端
- RDB|AOF `持久化`操作
- 主从`备份`
- 集群`同步`



# 参考
- [事件](https://redisbook.readthedocs.io/en/latest/internal/ae.html)