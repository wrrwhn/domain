<!doctype html>
<html class="no-js">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>好久不见</title>
        <meta name="author">
        <meta name="description" content="好久不见">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="generator" content="Hugo 0.30.2" />
        <link href="http://domain.yqjdcyy.com/post/index.xml" rel="alternate" type="application/rss+xml" title="好久不见" />
        <link href="http://domain.yqjdcyy.com/post/index.xml" rel="feed" type="application/rss+xml" title="好久不见" />
        <link href='//fonts.googleapis.com/css?family=Roboto:400,300,700|Noto+Serif:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="http://domain.yqjdcyy.com/css/styles.css">
        <link rel="icon" href="http://domain.yqjdcyy.com/favicon.ico">
        <link rel="apple-touch-icon" href="http://domain.yqjdcyy.com/apple-touch-icon.png" />
        <link rel="stylesheet" href="http://domain.yqjdcyy.com/css/highlightjs/monokai.css">
        <script src="http://domain.yqjdcyy.com/js/vendor/modernizr-2.8.0.min.js"></script>
        
        <style>
        .site-header h2 .logo {
        background: url(http://domain.yqjdcyy.com/img/desk.jpg) no-repeat 0 0;
        }
        @media (min--moz-device-pixel-ratio: 1.3), (-o-min-device-pixel-ratio: 2.6 / 2), (-webkit-min-device-pixel-ratio: 1.3), (min-device-pixel-ratio: 1.3), (min-resolution: 1.3dppx) {
          .site-header h2 .logo {
            background-image: url(http://domain.yqjdcyy.com/img/desk.jpg);
        }}
       .site-header {
         background: #2a373d url(http://domain.yqjdcyy.com/img/desk.jpg) no-repeat center center;
         z-index: -1;
        }
        </style>
    </head>
    <body>
        
        <header class="site-header">
          <div class="transparent-layer">
              <h2></h2>
          </div>
        </header>


<div class="container clearfix">
    <main role="main" class="content">
        <article class="post">
            <a class="btn home" href="http://domain.yqjdcyy.com/" title="">&laquo; </a>
            
<h1><a href="http://domain.yqjdcyy.com/post/%E5%B0%8F%E4%B8%B8%E5%8E%8B%E7%BC%A9%E8%A7%86%E9%A2%91%E8%BD%ACm3u8%E5%BC%82%E5%B8%B8/" title="小丸压缩视频转M3U8异常">小丸压缩视频转M3U8异常</a></h1>

<footer class="post-info"> <span class="post-meta"><time datetime="2018.03.03">2018.03.03</time>

    &middot; 
        
        <a href="http://domain.yqjdcyy.com/tags/%E6%95%B4%E7%90%86">整理</a>, 
        
        <a href="http://domain.yqjdcyy.com/tags/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86">异常处理</a>, 
        
        <a href="http://domain.yqjdcyy.com/tags/ffmpeg">ffmpeg</a>
        
    

</span>
</footer>

            

<p>[TOC]</p>

<h1 id="异常反馈">异常反馈</h1>

<ul>
<li><code>2 frames left in the queue on closing</code>
```
[2018/01/08:11:37:43] [ERROR] FFMPEG.STDERR:ffmpeg version 3.3.2 Copyright &copy; 2000-2017 the FFmpeg developers
built with gcc 4.8.2 (GCC) 20140120 (Red Hat 4.8.2-16)
configuration: &ndash;extra-cflags=-I/usr/local/ffmpeg/include &ndash;extra-ldflags=-L/usr/local/ffmpeg/lib &ndash;pkg-config-flags=&ndash;static &ndash;enable-libmp3lame &ndash;enable-gpl &ndash;enable-libvorbis &ndash;enable-libvpx &ndash;enable-libx264 &ndash;prefix=/usr/local/ffmpeg &ndash;extra-libs=-ldl
libavutil      55. 58.100 / 55. 58.100
libavcodec     57. 89.100 / 57. 89.100
libavformat    57. 71.100 / 57. 71.100
libavdevice    57.  6.100 / 57.  6.100
libavfilter     6. 82.100 /  6. 82.100
libswscale      4.  6.100 /  4.  6.100
libswresample   2.  7.100 /  2.  7.100
libpostproc    54.  5.100 / 54.  5.100
Input #0, mov,mp4,m4a,3gp,3g2,mj2, from &lsquo;/static/cdn/prod/video/27c82cb0-2e6f-471e-b038-20488b0ae82c.mp4&rsquo;:
Metadata:
major_brand     : isom
minor_version   : 512
&hellip;skipping&hellip;
configuration: &ndash;extra-cflags=-I/usr/local/ffmpeg/include &ndash;extra-ldflags=-L/usr/local/ffmpeg/lib &ndash;pkg-config-flags=&ndash;static &ndash;enable-libmp3lame &ndash;enable-gpl &ndash;enable-libvorbis &ndash;enable-libvpx &ndash;enable-libx264 &ndash;prefix=/usr/local/ffmpeg &ndash;extra-libs=-ldl
libavutil      55. 58.100 / 55. 58.100
libavcodec     57. 89.100 / 57. 89.100
libavformat    57. 71.100 / 57. 71.100
libavdevice    57.  6.100 / 57.  6.100
libavfilter     6. 82.100 /  6. 82.100
libswscale      4.  6.100 /  4.  6.100
libswresample   2.  7.100 /  2.  7.100
libpostproc    54.  5.100 / 54.  5.100
[mov,mp4,m4a,3gp,3g2,mj2 @ 0x30f35e0] stream 0, timescale not set
Input #0, mov,mp4,m4a,3gp,3g2,mj2, from &lsquo;/static/cdn/prod/video/38ad11be-f1c7-4dea-9ce0-6ed13a93d906.mp4&rsquo;:
Metadata:
major_brand     : isom
minor_version   : 1
compatible_brands: isom
creation_time   : 2017-06-26T08:38:48.000000Z
Duration: 00:06:01.69, start: 0.000000, bitrate: 485 kb/s
Stream #0:0(und): Video: h264 (High) (avc1 / 0x31637661), yuv420p(tv, bt709/unknown/unknown), 1920x1080, 340 kb/s, 25 fps, 25 tbr, 25 tbn, 50 tbc (default)
Metadata:
  creation_time   : 2017-06-26T08:31:14.000000Z
  handler_name    : GPAC ISO Video Handler
Stream #0:1(und): Audio: aac (LC) (mp4a / 0x6134706D), 48000 Hz, stereo, fltp, 129 kb/s (default)
Metadata:
  creation_time   : 2017-06-26T08:38:48.000000Z
  handler_name    : GPAC ISO Audio Handler
Stream #0:2: Video: png, rgba(pc), 1920x1080, 90k tbr, 90k tbn, 90k tbc
Stream mapping:
Stream #0:0 -&gt; #0:0 (h264 (native) -&gt; h264 (libx264))
Stream #0:1 -&gt; #0:1 (aac (native) -&gt; aac (native))
Stream #0:2 -&gt; #0:2 (png (native) -&gt; h264 (libx264))
Press [q] to stop, [?] for help
[libx264 @ 0x312d8e0] using cpu capabilities: MMX2 SSE2Fast SSSE3 SSE4.2 AVX
[libx264 @ 0x312d8e0] profile High, level 3.0
Past duration 0.639992 too large
Past duration 0.679985 too large
Past duration 0.719994 too large
Past duration 0.759987 too large
Past duration 0.799995 too large
Past duration 0.839989 too large
Past duration 0.879997 too large
Past duration 0.919991 too large
Past duration 0.959999 too large
frame=   66 fps=0.0 q=0.0 q=0.0 size=N/A time=-577014:32:22.77 bitrate=N/A dup=0 drop=1 speed=N/A    ^Mframe=  120 fps=120 q=0.0 q=0.0 size=N/A time=-577014:32:22.77 bitrate=N/A dup=0 drop=3 speed=N/A    ^MToo many packets buffered for output stream 0:1.
[libx264 @ 0x312d8e0] frame I:3     Avg QP:22.11  size:  3669
[libx264 @ 0x312d8e0] frame P:43    Avg QP:23.84  size:  2862
[libx264 @ 0x312d8e0] frame B:51    Avg QP:24.78  size:   931
[libx264 @ 0x312d8e0] consecutive B-frames: 24.5% 10.2% 12.2% 53.1%
[libx264 @ 0x312d8e0] mb I  I16..4: 11.7% 80.6%  7.7%
[libx264 @ 0x312d8e0] mb P  I16..4:  6.8%  9.1%  4.9%  P16..4: 11.0%  4.2%  1.8%  0.0%  0.0%    skip:62.1%
[libx264 @ 0x312d8e0] mb B  I16..4:  0.7%  0.9%  0.4%  B16..8: 21.6%  4.2%  0.8%  direct: 0.6%  skip:70.9%  L0:42.2% L1:50.3% BI: 7.5%
[libx264 @ 0x312d8e0] 8x8 transform intra:52.4% inter:59.5%
[libx264 @ 0x312d8e0] coded y,uvDC,uvAC intra: 26.9% 37.5% 21.8% inter: 3.8% 3.9% 1.2%
[libx264 @ 0x312d8e0] i16 v,h,dc,p: 37% 52%  5%  6%
[libx264 @ 0x312d8e0] i8 v,h,dc,ddl,ddr,vr,hd,vl,hu: 47% 24% 16%  2%  2%  3%  3%  2%  2%
[libx264 @ 0x312d8e0] i4 v,h,dc,ddl,ddr,vr,hd,vl,hu: 35% 32% 12%  4%  4%  4%  4%  3%  2%
[libx264 @ 0x312d8e0] i8c dc,h,v,p: 46% 32% 17%  5%
[libx264 @ 0x312d8e0] Weighted P-Frames: Y:0.0% UV:0.0%
[libx264 @ 0x312d8e0] ref P L0: 69.0%  6.9% 13.9% 10.2%
[libx264 @ 0x312d8e0] ref B L0: 83.8% 11.4%  4.8%
[libx264 @ 0x312d8e0] ref B L1: 94.0%  6.0%
[libx264 @ 0x312d8e0] kb/s:359.41
[aac @ 0x312e3c0] Qavg: 1583.189
[aac @ 0x312e3c0] 2 frames left in the queue on closing
Conversion failed!</li>
</ul>

<p>[2018/03/01:10:28:38] [ERROR] KafkaMsgHandler.convert fail: exit status 1
[2018/03/01:10:28:39] [ERROR] ReTry[10]: retry count is out of limit</p>

<pre><code>

# Command
- 原始转换请求转换语句
</code></pre>

<p>/usr/local/ffmpeg/bin/ffmpeg -i /static/cdn/prod/video/38ad11be-f1c7-4dea-9ce0-6ed13a93d906.mp4 -vcodec libx264 -r 24 -vf scale=640:360,pad=640:360:0:0:black -acodec aac -ar 22050 -ab 24k -map 0  -f ssegment -segment_format mpegts -segment_list /static/cdn/prod/video/38ad11be-f1c7-4dea-9ce0-6ed13a93d906_640x360/index.m3u8 -segment_time 10 /static/cdn/prod/video/38ad11be-f1c7-4dea-9ce0-6ed13a93d906_640x360/%04d.ts</p>

<pre><code>

# Info
- `/usr/local/ffmpeg/bin/ffprobe -i /static/cdn/prod/video/38ad11be-f1c7-4dea-9ce0-6ed13a93d906.mp4`
- 客户使用**「小丸」**进行视频压缩，添加末帧**图片作为视频流**，导致转 M3U8 时缓存不足引起转换失败
  - 理解为 FFMPEG 进行转码时，对各通道流进行同步缓存
  - 而图片流中图片仅存在于末帧，导致需要缓存的数据过多引发如上异常
  - 仅为与同事探讨的可能，如有知情，请烦请知会
</code></pre>

<p>ffprobe version 3.3.2 Copyright &copy; 2007-2017 the FFmpeg developers
    built with gcc 4.8.2 (GCC) 20140120 (Red Hat 4.8.2-16)
    configuration: &ndash;extra-cflags=-I/usr/local/ffmpeg/include &ndash;extra-ldflags=-L/usr/local/ffmpeg/lib &ndash;pkg-config-flags=&ndash;static &ndash;enable-libmp3lame &ndash;enable-gpl &ndash;enable-libvorbis &ndash;enable-libvpx &ndash;enable-libx264 &ndash;prefix=/usr/local/ffmpeg &ndash;extra-libs=-ldl
    libavutil      55. 58.100 / 55. 58.100
    libavcodec     57. 89.100 / 57. 89.100
    libavformat    57. 71.100 / 57. 71.100
    libavdevice    57.  6.100 / 57.  6.100
    libavfilter     6. 82.100 /  6. 82.100
    libswscale      4.  6.100 /  4.  6.100
    libswresample   2.  7.100 /  2.  7.100
    libpostproc    54.  5.100 / 54.  5.100
  [mov,mp4,m4a,3gp,3g2,mj2 @ 0x3b14b00] stream 0, timescale not set
  Input #0, mov,mp4,m4a,3gp,3g2,mj2, from &lsquo;/static/cdn/prod/video/38ad11be-f1c7-4dea-9ce0-6ed13a93d906.mp4&rsquo;:
    Metadata:
      major_brand     : isom
      minor_version   : 1
      compatible_brands: isom
      creation_time   : 2017-06-26T08:38:48.000000Z
    Duration: 00:06:01.69, start: 0.000000, bitrate: 485 kb/s
      Stream #0:0(und): Video: h264 (High) (avc1 / 0x31637661), yuv420p(tv, bt709/unknown/unknown), 1920x1080, 340 kb/s, 25 fps, 25 tbr, 25 tbn, 50 tbc (default)
      Metadata:
        creation_time   : 2017-06-26T08:31:14.000000Z
        handler_name    : GPAC ISO Video Handler
      Stream #0:1(und): Audio: aac (LC) (mp4a / 0x6134706D), 48000 Hz, stereo, fltp, 129 kb/s (default)
      Metadata:
        creation_time   : 2017-06-26T08:38:48.000000Z
        handler_name    : GPAC ISO Audio Handler
      Stream #0:2: Video: png, rgba(pc), 1920x1080, 90k tbr, 90k tbn, 90k tbc</p>

<pre><code>


# Ask
- [ffmpeg -max_muxing_queue_size](https://ffmpeg.org/ffmpeg.html)
- [[bug][regression] Too many packets buffered for output stream](https://trac.ffmpeg.org/ticket/6375#no2)
- [Conversion failed! by Too many packets buffered for output stream 0:0. in wmv](https://trac.ffmpeg.org/ticket/6472)


# Try
- `-max_muxing_queue_size 9999`
  - `06:01.69 485 kb/s 1920x1080`情况下视频，`9999`值足够使用
  - 时间超过**6min**则出现不足异常


# TODO
## Query
- 具体业务相关，略


## Demo
- 具体业务相关，略


## Command
</code></pre>

<p>/usr/local/ffmpeg/bin/ffmpeg -i /static/cdn/prod/video/57027182-0cba-4746-8eb4-8d4501da66d1.mp4 -vcodec libx264 -r 24 -vf scale=640:360,pad=640:360:0:0:black -acodec aac -ar 22050 -ab 24k -map 0 -f ssegment -segment_format mpegts -segment_list /static/cdn/prod/video/57027182-0cba-4746-8eb4-8d4501da66d1_640x360/index.m3u8 -segment_time 10 /static/cdn/prod/video/57027182-0cba-4746-8eb4-8d4501da66d1_640x360/%04d.ts</p>

<p>Kafka.Producer send(av, 1, {&ldquo;env&rdquo;:&ldquo;prod&rdquo;,&ldquo;args&rdquo;:&ldquo;id_37976-type_exercise&rdquo;,&ldquo;req&rdquo;:{&ldquo;type&rdquo;:3,&ldquo;from&rdquo;:&ldquo;/static/cdn/prod/video/57027182-0cba-4746-8eb4-8d4501da66d1.mp4&rdquo;,&ldquo;to&rdquo;:&ldquo;/static/cdn/prod/video/57027182-0cba-4746-8eb4-8d4501da66d1_640x360&rdquo;,&ldquo;args&rdquo;:&ldquo;format=phone&rdquo;}})
```</p>

<h1 id="update">Update</h1>

<ul>
<li>具体业务相关，略</li>
</ul>

<h1 id="request">Request</h1>

<ul>
<li>具体业务相关，略</li>
</ul>

            <ul class="share-buttons">
    <li></li>
    <li>
        <a class="icon-facebook-squared" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fdomain.yqjdcyy.com%2fpost%2f%25E5%25B0%258F%25E4%25B8%25B8%25E5%258E%258B%25E7%25BC%25A9%25E8%25A7%2586%25E9%25A2%2591%25E8%25BD%25ACm3u8%25E5%25BC%2582%25E5%25B8%25B8%2f" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" title=""></a>
    </li>
    <li>
        <a class="icon-twitter" href="https://twitter.com/share?text=%e5%b0%8f%e4%b8%b8%e5%8e%8b%e7%bc%a9%e8%a7%86%e9%a2%91%e8%bd%acM3U8%e5%bc%82%e5%b8%b8&amp;url=http%3a%2f%2fdomain.yqjdcyy.com%2fpost%2f%25E5%25B0%258F%25E4%25B8%25B8%25E5%258E%258B%25E7%25BC%25A9%25E8%25A7%2586%25E9%25A2%2591%25E8%25BD%25ACm3u8%25E5%25BC%2582%25E5%25B8%25B8%2f" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" title=""></a>
    </li>
    <li>
        <a class="icon-gplus" href="https://plus.google.com/share?url=http%3a%2f%2fdomain.yqjdcyy.com%2fpost%2f%25E5%25B0%258F%25E4%25B8%25B8%25E5%258E%258B%25E7%25BC%25A9%25E8%25A7%2586%25E9%25A2%2591%25E8%25BD%25ACm3u8%25E5%25BC%2582%25E5%25B8%25B8%2f" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;" title=""></a>
    </li>
    <li>
        <a class="icon-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fdomain.yqjdcyy.com%2fpost%2f%25E5%25B0%258F%25E4%25B8%25B8%25E5%258E%258B%25E7%25BC%25A9%25E8%25A7%2586%25E9%25A2%2591%25E8%25BD%25ACm3u8%25E5%25BC%2582%25E5%25B8%25B8%2f&title=%e5%b0%8f%e4%b8%b8%e5%8e%8b%e7%bc%a9%e8%a7%86%e9%a2%91%e8%bd%acM3U8%e5%bc%82%e5%b8%b8" onclick="window.open(this.href, 'linkedin-share', 'width=600,height=494');return false;" title=""></a>
    </li>
</ul>

        </article>
        
        <div class="comments">
            <h3></h3>
            <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "yqjdcyy-com" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </div>
        
    </main>
    <aside class="author">
  <img class="profile-image" src="http://domain.yqjdcyy.com/img/profile-image.png" alt="姚清居" />
  <p class="name"> 
  <strong>姚清居</strong></p>
  <p class="address">Earth</p>
  <p class="link"></p>
  <ul class="social">
    












<li><a href="//github.com/wrrwhn" class="icon-github" target="_blank" title="Github"></a></li>




<li><a href="http://domain.yqjdcyy.com/post/index.xml" class="icon-rss" target="_blank" title="RSS"></a></li>

  </ul>
  <br><br>
</aside>

</div>

<footer class="main-footer">
  <div class="container clearfix">
        <a class="icon-rss" href="http://domain.yqjdcyy.com/post/index.xml" title="RSS"></a>
        <p>&copy; 2018 &middot; Powered by <a href="http://www.domain.yqjdcyy.com">姚清居</a>.</p>
  </div>
</footer>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>window.jQuery || document.write('<script src="http:\/\/domain.yqjdcyy.com\/js\/vendor\/jquery-1.11.0.min.js"><\/script>')</script>
<script src="http://domain.yqjdcyy.com/js/plugins.js"></script>




</body>
</html>

