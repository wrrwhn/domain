<!doctype html>
<html class="no-js">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>READ FROM LIFE</title>
        <meta name="author">
        <meta name="description" content="姚清居到此一游">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="generator" content="Hugo 0.30.2" />
        <link href="http://domain.yqjdcyy.com/post/index.xml" rel="alternate" type="application/rss+xml" title="READ FROM LIFE" />
        <link href="http://domain.yqjdcyy.com/post/index.xml" rel="feed" type="application/rss+xml" title="READ FROM LIFE" />
        <link href='//fonts.googleapis.com/css?family=Roboto:400,300,700|Noto+Serif:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="http://domain.yqjdcyy.com/css/styles.css">
        <link rel="icon" href="http://domain.yqjdcyy.com/favicon.ico">
        <link rel="apple-touch-icon" href="http://domain.yqjdcyy.com/apple-touch-icon.png" />
        <link rel="stylesheet" href="http://domain.yqjdcyy.com/css/highlightjs/monokai.css">
        <script src="http://domain.yqjdcyy.com/js/vendor/modernizr-2.8.0.min.js"></script>
        
        <style>
        .site-header h2 .logo {
        background: url(http://domain.yqjdcyy.com/img/desk.jpg) no-repeat 0 0;
        }
        @media (min--moz-device-pixel-ratio: 1.3), (-o-min-device-pixel-ratio: 2.6 / 2), (-webkit-min-device-pixel-ratio: 1.3), (min-device-pixel-ratio: 1.3), (min-resolution: 1.3dppx) {
          .site-header h2 .logo {
            background-image: url(http://domain.yqjdcyy.com/img/desk.jpg);
        }}
       .site-header {
         background: #2a373d url(http://domain.yqjdcyy.com/img/desk.jpg) no-repeat center center;
         z-index: -1;
        }
        </style>
    </head>
    <body>
        
        <header class="site-header">
          <div class="transparent-layer">
              <h2></h2>
          </div>
        </header>


<div class="container clearfix">
    <main role="main" class="content">
        <article class="post">
            <a class="btn home" href="http://domain.yqjdcyy.com/" title="">&laquo; </a>
            
<h1><a href="http://domain.yqjdcyy.com/post/springboot.jpa/" title="SpringBoot.JPA">SpringBoot.JPA</a></h1>

<footer class="post-info"> <span class="post-meta"><time datetime="2016.12.11">2016.12.11</time>

    &middot; 
        
        <a href="http://domain.yqjdcyy.com/tags/%E6%95%B4%E7%90%86">整理</a>, 
        
        <a href="http://domain.yqjdcyy.com/tags/springboot">springboot</a>
        
    

</span>
</footer>

            

<h2 id="toc">[TOC]</h2>

<h1 id="文章来源">文章来源</h1>

<p><a href="http://docs.spring.io/spring-data/jpa/docs/1.8.0.RELEASE/reference/html/">Spring Data JPA - Reference Documentation</a></p>

<h1 id="学习整理">学习整理</h1>

<h2 id="basic-example">Basic Example</h2>

<pre><code>Entity
@Entity
@Table(name = &quot;user&quot;)
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.AUTO)
    private Long id;

    @Column(name = &quot;user_name&quot;)
    private long userName;
}

Repository
public interface UserRepository extends CrudRepository&lt;User, Long&gt; { // 必须指定操作对象及ID类型

  Long countByLastname(String lastname);
  List&lt;User&gt; findByLastname(String lastname);
}

Common-Repository
PagingAndSortingRepository
CrudRepository
Repository

Config
@Configuration
@EnableJpaRepositories(basePackages = &quot;com.yunkai&quot;) // 指定 Repository 位置
@ComponentScan(basePackages = &quot;com.yunkai&quot;)
@EntityScan(basePackages = &quot;com.yunkai&quot;) // 指定 Entity 对象位置
class ApplicationConfiguration {
  @Bean
  public EntityManagerFactory entityManagerFactory() {
    // …
  }
}

Using
@Autowired
private UserRepository repository;

Page&lt;User&gt; users = repository.findAll(new PageRequest(1, 20));

</code></pre>

<h2 id="cunstom-tuning">Cunstom-tuning</h2>

<pre><code>@NoRepositoryBean // 自定义基础库时使用，保证能被运行时创建
interface MyBaseRepository&lt;T, ID extends Serializable&gt; extends Repository&lt;T, ID&gt; {
  T save(T entity);
}
</code></pre>

<h2 id="defining-query-methods">Defining query methods</h2>

<pre><code>Query lookup strategies
CREATE 
USE_DECLARED_QUERY 
CREATE_IF_NOT_FOUND = CREATE+ USE_DECLARED_QUERY

Query creation
prefixes
find…by
read…by
query…by
count…by
get…by
expressions
distinct
and
or
operators
between
lessThan
GreaterThan
like
orderBy…asc|desc
parameter handling
Page
Slice
List
Pageable
Sort
limiting
first
top
Streaming
Java 8 Stream&lt;T&gt;
try (Stream&lt;User&gt; stream = repository.findAllByCustomQueryAndStream()) {
  stream.forEach(…);
}

Example
// 获取唯一值
List&lt;Person&gt; findDistinctPeopleByLastnameOrFirstname(String lastname, String firstname);
// 忽略大小写，单独忽略时跟在查询元素后
List&lt;Person&gt; findByLastnameIgnoreCase(String lastname);
List&lt;Person&gt; findByLastnameAndFirstnameAllIgnoreCase(String lastname, String firstname);
// 排序
List&lt;Person&gt; findByLastnameOrderByFirstnameAsc(String lastname);
// 查询 x.address.zipCode ，其中算法会遍历 AddressZipCode/ AddressZip+ Code/ Address+ ZipCode
List&lt;Person&gt; findByAddressZipCode(ZipCode zipCode);
// 同上，明确分词
List&lt;Person&gt; findByAddress_ZipCode(ZipCode zipCode);
// 分页列表查询
Page&lt;User&gt;|Slice&lt;User&gt;|List&lt;User&gt; findByLastname(String lastname, Pageable pageable|Sort sort);
// 指定前X条记录
User find[First|Top]ByOrderByLastnameAsc();
Page&lt;User&gt; query[First10|Top3]ByLastname(String lastname, Pageable pageable);
// 
@Query(&quot;select u from User u&quot;)
Stream&lt;User&gt; findAllByCustomQueryAndStream();
Stream&lt;User&gt; readAllByFirstnameNotNull();
</code></pre>

<h2 id="data-extensions">Data extensions</h2>

<pre><code>Web support
java config
@Configuration
@EnableWebMvc
@EnableSpringDataWebSupport
class WebConfiguration { }

Xml config
&lt;bean class=&quot;org.springframework.data.web.config.SpringDataWebConfiguration&quot; /&gt;
&lt;!-- If you're using Spring HATEOAS as well register this one *instead* of the former --&gt;
&lt;bean class=&quot;org.springframework.data.web.config.HateoasAwareSpringDataWebConfiguration&quot; /&gt;

config support
DomainClassConverter
Define
convert reuqest parameters or path variables to domain class
Example
@RequestMapping(&quot;/{id}&quot;)
   public String showUserForm(@PathVariable(&quot;id&quot;) User user, Model model) {} // id-&gt; user，domain call findOne automatic
HandlerMethodArgumentResolver
Define
resovle Pageable/ Sort instances from request parameters
Example
@RequestMapping
   public String showUsers(Model model, 
   Pageable pageable) {}
   public String showUsers(Model model,
        @Qualifier(&quot;foo&quot;) Pageable first,
          @Qualifier(&quot;bar&quot;) Pageable second) { … }
    Url request
     page=1&amp;size=10&amp;sort=firstname&amp;sort=lastname,asc
    Attention
     @PageableDefaults on controller.method
Auto create next and prev link
method
@RequestMapping(value = &quot;/persons&quot;, method = RequestMethod.GET)
HttpEntity&lt;PagedResources&lt;Person&gt;&gt; persons(Pageable pageable,
PagedResourcesAssembler assembler) {
Page&lt;Person&gt; persons = repository.findAll(pageable);
return new ResponseEntity&lt;&gt;(assembler.toResources(persons), HttpStatus.OK);
}
response
{ 
&quot;links&quot; : [ { &quot;rel&quot; : &quot;next&quot;, &quot;href&quot; : &quot;http://localhost:8080/persons?page=1&amp;size=20 }],
&quot;content&quot; : [… // 20 Person instances rendered here],
&quot;pageMetadata&quot; : {
&quot;size&quot; : 20,
&quot;totalElements&quot; : 30,
&quot;totalPages&quot; : 2,
&quot;number&quot; : 0
}
}

Repository populators
Json file
[ { &quot;_class&quot; : &quot;com.acme.Person&quot;,
 &quot;firstname&quot; : &quot;Dave&quot;,
  &quot;lastname&quot; : &quot;Matthews&quot; },
  { &quot;_class&quot; : &quot;com.acme.Person&quot;,
 &quot;firstname&quot; : &quot;Carter&quot;,
  &quot;lastname&quot; : &quot;Beauford&quot; } ]
XML config
&lt;repository:jackson-populator locations=&quot;classpath:data.json&quot; /&gt;
&lt;oxm:jaxb2-marshaller contextPath=&quot;com.acme&quot; /&gt;

</code></pre>

<h2 id="query-methods">Query methods</h2>

<pre><code>Query creation
**Keyword** **Sample** **JPQL snippet**
And  findByLastnameAndFirstname … where x.lastname = ?1 and x.firstname = ?2
Or  findByLastnameOrFirstname  … where x.lastname = ?1 or x.firstname = ?2
Is,Equals  findByFirstnameIs  … where x.firstname = 1?
Between  findByStartDateBetween  … where x.startDate between 1? and ?2
LessThan  findByAgeLessThan  … where x.age &lt; ?1
LessThanEqual findByAgeLessThanEqual  … where x.age ⇐ ?1
GreaterThan  findByAgeGreaterThan  … where x.age &gt; ?1
GreaterThanEqual  findByAgeGreaterThanEqual  … where x.age &gt;= ?1
After findByStartDateAfter  … where x.startDate &gt; ?1
Before findByStartDateBefore  … where x.startDate &lt; ?1
IsNull  findByAgeIsNull  … where x.age is null
IsNotNull,NotNull findByAge(Is)NotNull  … where x.age not null
Like  findByFirstnameLike  … where x.firstname like ?1
NotLike  findByFirstnameNotLike  … where x.firstname not like ?1
StartingWith  findByFirstnameStartingWith  … where x.firstname like ?1 (parameter bound with appended %)
EndingWith findByFirstnameEndingWith  … where x.firstname like ?1 (parameter bound with prepended %)
Containing  findByFirstnameContaining  … where x.firstname like ?1 (parameter bound wrapped in %)
OrderBy  findByAgeOrderByLastnameDesc  … where x.age = ?1 order by x.lastname desc
Not  findByLastnameNot  … where x.lastname &lt;&gt; ?1
In  findByAgeIn(Collection&lt;Age&gt; ages)  … where x.age in ?1
NotIn findByAgeNotIn(Collection&lt;Age&gt; age) … where x.age not in ?1
True  findByActiveTrue() … where x.active = true
False  findByActiveFalse()  … where x.active = false
IgnoreCase  findByFirstnameIgnoreCase  … where UPPER(x.firstame) = UPPER(?1)

Name Query
XML
/META-INF/orm.xml
&lt;named-query name=&quot;User.findByLastname&quot;&gt;
  &lt;query&gt;select u from User u where u.lastname = ?1&lt;/query&gt;
&lt;/named-query&gt;
Annotation
@Entity
@NamedQuery(name = &quot;User.findByEmailAddress&quot;,
  query = &quot;select u from User u where u.emailAddress = ?1&quot;)
public class User {}
Repository
public interface UserRepository extends JpaRepository&lt;User, Long&gt; {
  User findByEmailAddress(String emailAddress);
}

Query
take precedence over name query
Annotation
JPQL query 
@Query(&quot;select u from User u where u.firstname like %?1&quot;)
List&lt;User&gt; findByFirstnameEndsWith(String firstname);
Native Query
@Query(value = &quot;SELECT * FROM USERS WHERE EMAIL_ADDRESS = ?0&quot;, nativeQuery = true)
User findByEmailAddress(String emailAddress);
@Query(&quot;select u from #{#entityName} u where u.lastname = ?1&quot;)
List&lt;User&gt; findByLastname(String lastname);
Native Query with named parameters
@Query(&quot;select u from User u where u.firstname = :firstname or u.lastname = :lastname&quot;)
User findByLastnameOrFirstname(@Param(&quot;lastname&quot;) String lastname, @Param(&quot;firstname&quot;) String firstname);

Modifying Query
Annotation
@Modifying
@Query(&quot;update User u set u.firstname = ?1 where u.lastname = ?2&quot;)
int setFixedFirstnameFor(String firstname, String lastname);
注： @Modifying(clearAutomatically = true) 可促使 EntityManager 立即抛弃缓存的数据并重新读取

Query Hints
user for cache data
Annotation
@QueryHints({ @QueryHint(name = &quot;org.hibernate.cacheable&quot;, value =&quot;true&quot;) })
public User findById(long id);

Load Graphs
Annotation
@Entity
@NamedEntityGraph(name = &quot;GroupInfo.detail&quot;, attributeNodes = @NamedAttributeNode(&quot;members&quot;))
public class GroupInfo {}

@Repository
public interface GroupRepository extends CrudRepository&lt;GroupInfo, String&gt; {
   @EntityGraph(value = &quot;GroupInfo.detail&quot;, type = EntityGraphType.LOAD)
   GroupInfo getByGroupName(String name);
}
</code></pre>

<h2 id="stored-procedures">Stored Procedures</h2>

<pre><code>HSQL DB Definition
/;
DROP procedure IF EXISTS plus1inout
/;
CREATE procedure plus1inout (IN arg int, OUT res int)
BEGIN ATOMIC
set res = arg ` 1;
END
/;
Entity Definition
@Entity
@NamedStoredProcedureQuery(name = &quot;User.plus1&quot;, procedureName = &quot;plus1inout&quot;, parameters = {
@StoredProcedureParameter(mode = ParameterMode.IN, name = &quot;arg&quot;, type = Integer.class),
@StoredProcedureParameter(mode = ParameterMode.OUT, name = &quot;res&quot;, type = Integer.class) })
public class User {}
Mapped In Database
@Procedure(&quot;plus1inout&quot;)
Integer explicitlyNamedPlus1inout(Integer arg);
</code></pre>

<h2 id="specifications">Specifications</h2>

<pre><code>Interface
public interface Specification&lt;T&gt; {
  Predicate toPredicate(Root&lt;T&gt; root, CriteriaQuery&lt;?&gt; query, CriteriaBuilder builder);
}
Definition
public class CustomerSpecs {
  public static Specification&lt;Customer&gt; isLongTermCustomer() {
    return new Specification&lt;Customer&gt;() {
      public Predicate toPredicate(Root&lt;Customer&gt; root, CriteriaQuery&lt;?&gt; query, CriteriaBuilder builder) {
         LocalDate date = new LocalDate().minusYears(2);
         return builder.lessThan(root.get(_Customer.createdAt), date);
      }
    };
  }
  public static Specification&lt;Customer&gt; hasSalesOfMoreThan(MontaryAmount value) {
    return new Specification&lt;Customer&gt;() {
      public Predicate toPredicate(Root&lt;T&gt; root, CriteriaQuery&lt;?&gt; query, CriteriaBuilder builder) {}
    };
  }
}
Using
List&lt;Customer&gt; customers = customerRepository.findAll(where(isLongTermCustomer()).or(hasSalesOfMoreThan(amount)));

</code></pre>

<h2 id="transaction">Transaction</h2>

<pre><code>Retrieve
Benefit
rollback after setted timeout
improve the 
Example
@Transactional(timeout = 10, readOnly= true)
public List&lt;User&gt; findAll();

Create/Update/Delete
Benefit
ensure the data is correct
Example
@Transactional
public void addRoleToAllUsers(String roleName)
@Modifying
@Transactional
@Query(&quot;delete from User u where u.active = false&quot;)
void deleteInactiveUsers();
</code></pre>

<h2 id="locking">Locking</h2>

<pre><code>@Lock(LockModeType.READ)
List&lt;User&gt; findByLastname(String lastname);
</code></pre>

<h2 id="auditing">Auditing</h2>

<pre><code>Base Metadata Annotation
@CreateBy | @LastModifiedBy | @CreateDate | @LastModifiedDate
-&gt; 实体调整时自动赋值

</code></pre>

            <ul class="share-buttons">
    <li></li>
    <li>
        <a class="icon-facebook-squared" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fdomain.yqjdcyy.com%2fpost%2fspringboot.jpa%2f" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" title=""></a>
    </li>
    <li>
        <a class="icon-twitter" href="https://twitter.com/share?text=SpringBoot.JPA&amp;url=http%3a%2f%2fdomain.yqjdcyy.com%2fpost%2fspringboot.jpa%2f" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" title=""></a>
    </li>
    <li>
        <a class="icon-gplus" href="https://plus.google.com/share?url=http%3a%2f%2fdomain.yqjdcyy.com%2fpost%2fspringboot.jpa%2f" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;" title=""></a>
    </li>
    <li>
        <a class="icon-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fdomain.yqjdcyy.com%2fpost%2fspringboot.jpa%2f&title=SpringBoot.JPA" onclick="window.open(this.href, 'linkedin-share', 'width=600,height=494');return false;" title=""></a>
    </li>
</ul>

        </article>
        
        <div class="comments">
            <h3></h3>
            <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "yqjdcyy-com" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </div>
        
    </main>
    <aside class="author">
  <img class="profile-image" src="http://domain.yqjdcyy.com/img/profile-image.png" alt="姚清居" />
  <p class="name"> 
  <strong>姚清居</strong></p>
  <p class="address">Earth</p>
  <p class="link"></p>
  <ul class="social">
    












<li><a href="//github.com/wrrwhn" class="icon-github" target="_blank" title="Github"></a></li>




<li><a href="http://domain.yqjdcyy.com/post/index.xml" class="icon-rss" target="_blank" title="RSS"></a></li>

  </ul>
  <br><br>
</aside>

</div>

<footer class="main-footer">
  <div class="container clearfix">
        <a class="icon-rss" href="http://domain.yqjdcyy.com/post/index.xml" title="RSS"></a>
        <p>&copy; 2018 &middot; Powered by <a href="http://www.yqjdcyy.com">姚清居</a>.</p>
  </div>
</footer>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>window.jQuery || document.write('<script src="http:\/\/domain.yqjdcyy.com\/js\/vendor\/jquery-1.11.0.min.js"><\/script>')</script>
<script src="http://domain.yqjdcyy.com/js/plugins.js"></script>




</body>
</html>

